#!/usr/bin/env python3

################################# Write-Up #####################################
# Challenge: More Cookies
# Category: Web Exploitation
# Description: I forgot Cookies can Be modified Client-side, so now I decided to encrypt them! http://mercury.picoctf.net:15614/
# Hints:
#	-1: https://en.wikipedia.org/wiki/Homomorphic_encryption
#	-2: The search endpoint is only helpful for telling you if you are admin or not, you won't be able to guess the flag name
#
# The first hint led me to learn about the idea of homomorhic encrytion, which
# is a type of encrytion that allows you to interact with the information
# encrypted without dectypting it. From the capital letter in the description,
# it seemed like the encrption being alluded to was AES-CBC, a block cipher
# encryption scheme. According to the write-ups I looked over, the idea to
# exploit the encrytion was to perform a CBC bitflip attack, which is basically
# XORing a byte in the encrypted ciphertext so as to modify the content of the
# plaintext itself. In this case, modifying one byte with a bitflip of the
# auth_name cookie on the website would lead to the correct cookie that would
# make you the admin and allow you to view the flag.
#
# Flag: picoCTF{cO0ki3s_yum_a9a19fa6}
# Points: 90
# Solved in picoGym
# Note: This script itself does not work for some reason, I got the flag using a solution script from a write-up. The algorithm for performing the bitflip is correct though.
################################################################################
from base64 import b64decode
from base64 import b64encode
import requests
from requests.adapters import HTTPAdapter
from requests.packages.urllib3.util.retry import Retry

cookie = "MmN0MWxKMXZUVXpZaVRvc3hUcHJGQ2pLZG9JRnFQVFR4VmZ0UU5xbmZRQllURE5jVmlrSjM5VU54cWUyam9WeGtyZVNaMXpmaUt4V3lmQ00rNE9lVzBuWndaa29Fc0JCMnJrOWlCK3VxajMvb0hScmd5cDB1aVZWUFR2YkJIU2U="
def bitFlip(index, bit, string):
	cooked = b64decode(b64decode(string).decode())
	#print(cooked)
	nums = bytearray(cooked) #Strings don't have item assignment properties in Python :(; lists, tuples and dictionaries do
	#print(nums, type(nums))
	nums[index] = nums[index] ^ bit
	burnt = bytes(nums)
#	for k in nums: #Turns list of nums representing letters of cookie back into string of letters in cookie
#		burnt += chr(k)
	#print(burnt, type(burnt))
	return b64encode(b64encode(burnt)).decode()

#c = bitFlip(0,0,cookie)
#print(c, type(c))
#print(str(c), type(c))
'''r = requests.Session()
retry = Retry(connect=3, backoff_factor=0.5)
adapter = HTTPAdapter(max_retries=retry)
r.mount('http://', adapter)
r.mount('https://', adapter)'''
for i in range(128): #Bruteforce bit at different positions in cookie, length of cookie is 128
	for j in range(129):
		print(i, j)
		c = bitFlip(i, j, cookie)
		auth = {'auth_name' : c}
		#print(auth)
		s = requests.get("http://mercury.picoctf.net:15614/", cookies=auth) #GET request to site with supplied cookie
		#print(s.text)
		if "picoCTF{" in s.text:
			print(s.text)
			print("Bit " + str(j) + " XORed with char at index " + str(i))
			break
